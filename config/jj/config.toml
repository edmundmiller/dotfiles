# =============================================================================
# JJ (Jujutsu) Configuration
# =============================================================================
# Additional configs in conf.d/:
# - credits_roll.toml: Rich log formatting (fetched from YPares/jj.conf.d)
# - fix.toml: Code formatters (jj fix)
# - seqera.toml: Work repos (~/src/seqera, ~/src/nextflow)
# - nfcore.toml: nf-core repos (~/src/nf-core)
# - fg.toml: UTD academic repos (~/src/fg)

# =============================================================================
# USER INFO
# =============================================================================

[user]
name = "Edmund Miller"
email = "git@edmundmiller.dev"

# =============================================================================
# UI SETTINGS
# =============================================================================

[ui]
default-command = "log"
pager = "less -FRX"
paginate = "auto"
allow-filesets = true

# Diff and editing
diff-formatter = ["difft", "--color=always", "$left", "$right"]
diff-editor = ["nvim", "-c", "DiffEditor $left $right $output"]
merge-editor = "diffconflicts"
editor = "nvim"

# Display options
log-word-wrap = true
graph.style = "square"
relative-timestamps = true

[ui.movement]
edit = true  # Make edit mode default for prev/next

[core]
whitespace = "trailing-space"

# =============================================================================
# SIGNING
# =============================================================================

[signing]
# Use "drop" to avoid 1Password signing prompts during normal work
# Commits will be signed in batch when pushing (see git.sign-on-push)
behavior = "drop"
backend = "ssh"
key = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPBsb81evtCCcWSZcLbFaXWrAeCWFrPXPjUvjH4ZKbQC"

[signing.backends.ssh]
program = "/Applications/1Password.app/Contents/MacOS/op-ssh-sign"

# =============================================================================
# GIT INTEGRATION
# =============================================================================

[git]
sign-on-push = true
push-branch-prefix = "push-"
push-bookmarks-prefix = "emiller/"
track-default-bookmark-on-clone = false

[remotes.origin]
auto-track-bookmarks = '*'  # Auto-import git branches as jj bookmarks

# =============================================================================
# TEMPLATES - Triple Template System
# =============================================================================
# Three log styles for different use cases:
#
# 1. credits_roll (default) - Rich visual formatting with diff stats
#    Usage: jj log (default)
#
# 2. human_log - Clean, readable for daily human use
#    Usage: jj lh (log human)
#
# 3. ai_log - Minimal, structured for AI agents
#    Usage: jj la (log ai)

[templates]
# Default: AI-optimized for agent workflows (token-efficient, parseable)
# Use `jj lh` for human-friendly, `jj lc` for visual credits_roll
log_node = "builtin_log_node"
log = "ai_log"

[template-aliases]
# -----------------------------------------------------------------------------
# AI-Friendly Template (DEFAULT - minimal, structured, token-efficient)
# For AI agents and scripts - easy to parse, includes context
# -----------------------------------------------------------------------------
'ai_log' = '''
change_id.shortest(8) ++ " "
++ commit_id.shortest(8) ++ " "
++ if(author.email() != "git@edmundmiller.dev", "[" ++ author.email().local() ++ "] ", "")
++ committer.timestamp().ago() ++ " "
++ if(empty, "∅ ", "")
++ if(conflict, "✖ ", "")
++ if(immutable, "◆ ", "")
++ bookmarks ++ " "
++ description.first_line()
++ "\n"
'''

# -----------------------------------------------------------------------------
# Human-Friendly Template (balanced readability)
# Clean daily driver without credits_roll's visual complexity
# -----------------------------------------------------------------------------
'human_log' = '''
separate(" ",
  label("magenta", change_id.shortest(8).prefix()),
  label("dim", change_id.shortest(8).rest()),
  label("blue", commit_id.shortest(8)),
  if(empty, label("empty", "∅")),
  if(immutable, label("immutable", "◆")),
  if(conflict, label("conflict", "✖")),
  label("green", bookmarks),
  label("yellow", tags),
) ++ "\n"
++ if(description,
    "  " ++ label("white", description.first_line()) ++ "\n",
    "  " ++ label("description placeholder", "(no description)") ++ "\n"
)
++ if(author.name() != "Edmund Miller",
    "  " ++ label("dim", "by " ++ author.name()) ++ "\n",
    ""
)
'''

# -----------------------------------------------------------------------------
# Shell Prompt Template
# For starship/shell integration - ultra-compact
# -----------------------------------------------------------------------------
'prompt' = '''
separate(" ",
  change_id.shortest(4),
  commit_id.shortest(4),
  if(empty, label("empty", "∅")),
  if(conflict, label("conflict", "✖")),
  if(description == "", label("description placeholder", "✏"))
)
'''

# =============================================================================
# ALIASES - Grouped by Purpose
# =============================================================================

[aliases]
# -----------------------------------------------------------------------------
# Navigation
# -----------------------------------------------------------------------------
p = ["prev", "--edit"]
n = ["next", "--edit"]

# -----------------------------------------------------------------------------
# Viewing (Log variants)
# -----------------------------------------------------------------------------
# Default `jj log` is now AI-optimized (ai_log template + mine() revset)
l = ["log", "-r", "(main..@):: | (main..@)-"]         # Recent relative to main
la = ["log"]                                          # AI log (now default)
lh = ["log", "--template", "human_log"]               # Human-friendly log
lc = ["log", "--template", "credits_roll(0, 'none()')"]  # Visual credits_roll
lg = ["log", "--graph", "--color=always"]             # Graph view
lm = ["log", "-r", "::@ | ::main"]                    # Log with main
ls = ["files"]                                        # List files
pp = ["log", "--template", "builtin_log_detailed"]    # Pretty print detailed
recent = ["log", "-r", "::@ ~ ::trunk()"]             # Not in trunk yet
work = ["log", "-r", "(mine() & ~empty()) | @"]       # Show meaningful work

# Fallback aliases to see beyond mine() filter
la-all = ["log", "-r", "all()"]                       # All commits (verbose)
la-team = ["log", "-r", "~mine()"]                    # Others' commits only

# -----------------------------------------------------------------------------
# Basic Operations
# -----------------------------------------------------------------------------
st = ["status"]
amend = ["describe", "--edit"]
uncommit = ["backout", "-r", "@"]
wip = ["describe", "-m", "WIP"]

# -----------------------------------------------------------------------------
# Git Operations
# -----------------------------------------------------------------------------
sync = ["git", "fetch", "--all-remotes"]

# -----------------------------------------------------------------------------
# Bookmark Management
# -----------------------------------------------------------------------------
# Move closest bookmark to current commit (useful before pushing)
# References: https://shaddy.dev/notes/jj-tug/
tug = ["bookmark", "move", "--from", "heads(::@- & bookmarks())", "--to", "@-"]

# -----------------------------------------------------------------------------
# Rebase & Workflow
# -----------------------------------------------------------------------------
retrunk = ["rebase", "-d", "trunk()"]
evolve = ["evolve", "--quiet"]

# -----------------------------------------------------------------------------
# Cleanup & Maintenance
# -----------------------------------------------------------------------------
cleanup = ["abandon", "-r", "empty() & ~@"]
abandon-empty = ["abandon", "-r", "empty() & description(\"\")"]
tidy = ["abandon", "-r", "empty() & description(\"\") & ~@"]
orphans = ["log", "-r", "mine() & ~::trunk() & ~::@"]

# -----------------------------------------------------------------------------
# AI Commit Messages
# -----------------------------------------------------------------------------
ai-desc = ["util", "exec", "--", "/Users/emiller/.config/dotfiles/bin/jj-ai-desc.py"]
aid = ["util", "exec", "--", "/Users/emiller/.config/dotfiles/bin/jj-ai-desc.py"]
aide = ["util", "exec", "--", "/Users/emiller/.config/dotfiles/bin/jj-ai-desc.py", "--edit"]

# -----------------------------------------------------------------------------
# GitHub/PR Tools
# -----------------------------------------------------------------------------
spr = ["util", "exec", "--", "nix", "run", "/Users/edmundmiller/.config/dotfiles#jj-spr", "--"]
nd = ["util", "exec", "--", "/Users/edmundmiller/.config/dotfiles/bin/jj-nd", "--"]

# -----------------------------------------------------------------------------
# Diagnostics
# -----------------------------------------------------------------------------
ranked-authors = ["log", "--template", "author"]

# =============================================================================
# REVSET ALIASES
# =============================================================================

[revset-aliases]
'closest_bookmark(to)' = 'heads(::to & bookmarks())'
"fork_history(to, from)" = "fork_point(to | from)..@"

# =============================================================================
# REVSETS
# =============================================================================

[revsets]
trunk = "main@origin"
# AI-optimized: Only YOUR unmerged work (not all branches in repo)
log = "@ | ancestors(trunk()..(visible_heads() & mine()), 2) | trunk()"
mine = "author(exact:\"Edmund Miller\")"
recent-changes = "::@ & ~::trunk()"
stale = "committer_date(before:\"2 weeks ago\") & mine() & ~::trunk()"
clean-log = "@ | ancestors(@ | trunk(), 2) | trunk()"
active = "mine() & ~empty() & ~immutable()"

# =============================================================================
# SNAPSHOT SETTINGS
# =============================================================================

[snapshot]
# Auto-track source files, excluding build/output directories
auto-track = "(glob:**/*.js|glob:**/*.ts|glob:**/*.tsx|glob:**/*.jsx|glob:**/*.py|glob:**/*.rs|glob:**/*.go|glob:**/*.java|glob:**/*.c|glob:**/*.cpp|glob:**/*.h|glob:**/*.hpp|glob:**/*.nix|glob:**/*.toml|glob:**/*.yaml|glob:**/*.yml|glob:**/*.json|glob:**/*.md) & ~glob:**/node_modules/** & ~glob:**/.nextflow/** & ~glob:**/work/** & ~glob:**/results/** & ~glob:**/.lineage"
max-new-file-size = "10MB"

# =============================================================================
# MERGE TOOLS
# =============================================================================

[merge-tools.diffconflicts]
program = "nvim"
merge-args = [
  "-c",
  "let g:jj_diffconflicts_marker_length=$marker_length",
  "-c",
  "JJDiffConflicts!",
  "$output",
  "$base",
  "$left",
  "$right",
]
merge-tool-edits-conflict-markers = true
