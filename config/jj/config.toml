[user]
name = "Edmund Miller"
email = "git@edmundmiller.dev"

# Additional configs are in conf.d/
# - seqera.toml: Work repos (~/src/seqera, ~/src/nextflow)
# - nfcore.toml: nf-core repos (~/src/nf-core)
# - fg.toml: UTD academic repos (~/src/fg)
# - fix.toml: Code formatting tools (jj fix)

[aliases]
# Common git-like aliases
amend = ["describe", "--edit"]
lg = ["log", "--graph", "--color=always"]
ls = ["files"]
st = ["status"]

# Custom aliases matching your git setup
ranked-authors = ["log", "--template", "author"]
lm = ["log", "-r", "::@ | ::main"]

# Workflow shortcuts
l = ["log", "-r", "(main..@):: | (main..@)-"] # Recent changes relative to main
uncommit = ["backout", "-r", "@"] # Undo last commit keeping changes
sync = ["git", "fetch", "--all-remotes"] # Fetch from all remotes
wip = ["describe", "-m", "WIP"] # Quick work-in-progress commit
pp = [
  "log",
  "--template",
  "builtin_log_detailed",
] # Pretty print with full descriptions
recent = ["log", "-r", "::@ ~ ::trunk()"] # Recent commits not in trunk
evolve = ["evolve", "--quiet"] # Quietly evolve commits
# Move the closest bookmark to the current commit. This is useful when
# working on a named branch, creating a bunch of commits, and then needing
# to update the bookmark before pushing.
# References:
# - https://shaddy.dev/notes/jj-tug/
# - https://github.com/jj-vcs/jj/discussions/5568
tug = ["bookmark", "move", "--from", "heads(::@- & bookmarks())", "--to", "@-"]

# Rebase the current branch onto the trunk.
retrunk = ["rebase", "-d", "trunk()"]

# Quick navigation
p = ["prev", "--edit"] # Go to previous commit in edit mode
n = ["next", "--edit"] # Go to next commit in edit mode

# Cleanup aliases for maintaining clean history
cleanup = [
  "abandon",
  "-r",
  "empty() & ~@",
] # Clean up all empty commits except current
work = ["log", "-r", "(mine() & ~empty()) | @"] # Show only meaningful work
orphans = ["log", "-r", "mine() & ~::trunk() & ~::@"] # Show orphaned branches
abandon-empty = [
  "abandon",
  "-r",
  "empty() & description(\"\")",
] # Remove empty unnamed commits
tidy = [
  "abandon",
  "-r",
  "empty() & description(\"\") & ~@",
] # Safe cleanup of empty commits

# GitHub Pull Request management
spr = ["util", "exec", "--", "nix", "run", "/Users/edmundmiller/.config/dotfiles#jj-spr", "--"] # Stacked pull requests with jj-spr
nd = ["util", "exec", "--", "/Users/edmundmiller/.config/dotfiles/bin/jj-nd", "--"] # Open diff in neovim (PR preview)

# AI-powered commit message generation
ai-desc = ["util", "exec", "--", "/Users/emiller/.config/dotfiles/bin/jj-ai-desc.py"]
aid = ["util", "exec", "--", "/Users/emiller/.config/dotfiles/bin/jj-ai-desc.py"] # Short alias for ai-desc
aide = ["util", "exec", "--", "/Users/emiller/.config/dotfiles/bin/jj-ai-desc.py", "--edit"] # AI-desc with editor

[revset-aliases]
# Find the closest bookmark in the ancestry of a given revision
'closest_bookmark(to)' = 'heads(::to & bookmarks())'
"fork_history(to, from)" = "fork_point(to | from)..@"

# Merge conflict resolution tools
#
# Default: diffconflicts (nvim-based)
# For .beads/ files: use `jj resolve --tool=beads-merge`
[merge-tools.diffconflicts]
program = "nvim"
merge-args = [
  "-c",
  "let g:jj_diffconflicts_marker_length=$marker_length",
  "-c",
  "JJDiffConflicts!",
  "$output",
  "$base",
  "$left",
  "$right",
]
merge-tool-edits-conflict-markers = true

# Beads merge tool for .beads/issues.jsonl conflicts
# Uses bd's field-level 3-way merge algorithm
# Invoke with: jj resolve --tool=beads-merge
[merge-tools.beads-merge]
program = "bd"
merge-args = ["merge", "$output", "$base", "$left", "$right"]
merge-conflict-exit-codes = [1]

[ui]
# default-command = "status"
diff-formatter = ["difft", "--color=always", "$left", "$right"]
pager = "less -FRX"
diff-editor = ["nvim", "-c", "DiffEditor $left $right $output"]
merge-editor = "diffconflicts"
editor = "nvim"
# Enable word wrapping in logs for better readability
log-word-wrap = true
# Change graph style for cleaner visualization
graph.style = "square"
# Show relative timestamps
relative-timestamps = true
# Paginate long outputs automatically
paginate = "auto"
# Automatically abandon empty commits on certain operations
allow-filesets = true
default-command = "log"

[ui.movement]
# Make edit mode default for prev/next commands
edit = true

[core]
whitespace = "trailing-space"

[signing]
# Use "drop" to avoid 1Password signing prompts during normal work
# Commits will be signed in batch when pushing (see git.sign-on-push below)
behavior = "drop"
backend = "ssh"
key = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPBsb81evtCCcWSZcLbFaXWrAeCWFrPXPjUvjH4ZKbQC"

[signing.backends.ssh]
program = "/Applications/1Password.app/Contents/MacOS/op-ssh-sign"

[git]
# lazily signing only on push.
sign-on-push = true
push-branch-prefix = "push-"
# Don't create unnecessary local bookmarks when cloning
track-default-bookmark-on-clone = false
# Allow pushing new bookmarks to remote
push-bookmarks-prefix = "emiller/"

[remotes.origin]
# Only auto-track your own bookmarks + shared branches (reduces clutter from team branches)
# Use `jj bookmark track <name>@origin` to manually track others when needed
auto-track-bookmarks = "glob:emiller/* | exact:main | exact:master | exact:dev"

[revsets]
# Equivalent to git's push.default=current
trunk = "main@origin"
# Useful revset aliases for common queries
log = "@ | ancestors(immutable_heads().., 2) | trunk()"                  # Default log view
mine = "author(exact:\"Edmund Miller\")"                                 # Your commits
recent-changes = "::@ & ~::trunk()"                                      # Changes not yet in trunk
stale = "committer_date().before(\"2 weeks ago\") & mine() & ~::trunk()" # Old unmerged work
# Cleaner log views
clean-log = "@ | ancestors(@ | trunk(), 2) | trunk()" # Simplified default log
active = "mine() & ~empty() & ~immutable()"           # Active work in progress

[snapshot]
# Automatically track new files in src directories
auto-track = "(glob:**/*.js|glob:**/*.ts|glob:**/*.tsx|glob:**/*.jsx|glob:**/*.py|glob:**/*.rs|glob:**/*.go|glob:**/*.java|glob:**/*.c|glob:**/*.cpp|glob:**/*.h|glob:**/*.hpp|glob:**/*.nix|glob:**/*.toml|glob:**/*.yaml|glob:**/*.yml|glob:**/*.json|glob:**/*.md) & ~glob:**/node_modules/** & ~glob:**/.nextflow/** & ~glob:**/work/** & ~glob:**/results/** & ~glob:**/.lineage"
# Maximum file size to auto-track (10MB)
max-new-file-size = "10MB"

[templates]
log_node = "credits_roll_node"
log = "credits_roll(0, 'none()')"

[template-aliases]
# Prompt template for shell integration - optimized for performance
'prompt' = '''
separate(" ",
  format_short_change_id_with_hidden_and_divergent_info(self),
  format_short_commit_id(commit_id),
  if(empty, label("empty", "(empty)"), ""),
  if(description == "", label("description placeholder", "(no description)"), "")
)
'''
