#!/usr/bin/env bash
# bd-capture: Interactive beads issue capture via gum
# Launched from tmux popup (prefix + i)

set -euo pipefail

# Colors
RED=196
GREEN=82
DIM=245

# Check beads initialized
if [[ ! -d .beads ]]; then
    gum style --foreground "$RED" --bold "Error: Not in a beads-initialized directory"
    gum style --foreground "$DIM" "Run 'bd init' to initialize beads here"
    read -n 1 -s -r -p "Press any key to close..."
    exit 1
fi

# Title (required)
TITLE=$(gum input --placeholder "Issue title..." --width 70 --header "Title")
[[ -z "$TITLE" ]] && exit 0

# Type selection with task as default
TYPE=$(gum choose --header "Type" --selected "task" \
    "task" "bug" "feature" "epic" "chore")

# Priority selection with P2 as default
PRIORITY_FULL=$(gum choose --header "Priority" --selected "P2 (Medium)" \
    "P0 (Critical)" \
    "P1 (High)" \
    "P2 (Medium)" \
    "P3 (Low)" \
    "P4 (Backlog)")
PRIORITY=$(echo "$PRIORITY_FULL" | cut -d' ' -f1)

# Description (optional - just press Enter to skip)
DESC=$(gum input --header "Description (optional)" --placeholder "Add details..." --width 70)

# Build command
CMD=(bd create --title "$TITLE" --type "$TYPE" --priority "$PRIORITY")
[[ -n "$DESC" ]] && CMD+=(--description "$DESC")

# Confirmation summary
SUMMARY="Title: $TITLE
Type: $TYPE
Priority: $PRIORITY"
[[ -n "$DESC" ]] && SUMMARY+=$'\n'"Description: $DESC"

gum style --border rounded --padding "0 1" --border-foreground "$DIM" "$SUMMARY"
echo

if ! gum confirm "Create this issue?"; then
    gum style --foreground "$DIM" "Cancelled"
    sleep 1
    exit 0
fi

# Create issue
if OUTPUT=$("${CMD[@]}" 2>&1); then
    ISSUE_ID=$(echo "$OUTPUT" | grep -oE 'beads-[0-9]+' | head -1)
    if [[ -n "$ISSUE_ID" ]]; then
        echo "$ISSUE_ID" | pbcopy
        gum style --foreground "$GREEN" --bold "Created: $ISSUE_ID (copied to clipboard)"
    else
        gum style --foreground "$GREEN" --bold "Issue created"
        echo "$OUTPUT"
    fi
    sleep 2
else
    gum style --foreground "$RED" --bold "Error creating issue:"
    echo "$OUTPUT"
    read -n 1 -s -r -p "Press any key to close..."
    exit 1
fi
