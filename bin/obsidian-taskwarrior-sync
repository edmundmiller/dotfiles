#!/usr/bin/env bash
#
# Obsidian-Taskwarrior Sync Wrapper
# Provides easy sync commands for Obsidian vault tasks
#

set -euo pipefail

# Configuration
VAULT_PATH="$HOME/Documents/Obsidian Vault"
SYNC_SCRIPT="$HOME/repos/obsidian-taskwarrior-sync/mtt_sync.sh"

# Check if sync script exists
if [[ ! -f "$SYNC_SCRIPT" ]]; then
    echo "‚ùå Error: obsidian-taskwarrior-sync not found at $SYNC_SCRIPT"
    echo "Run: git clone https://github.com/nbossard/obsidian-taskwarrior-sync.git ~/repos/obsidian-taskwarrior-sync"
    exit 1
fi

# Check if vault exists
if [[ ! -d "$VAULT_PATH" ]]; then
    echo "‚ùå Error: Obsidian vault not found at $VAULT_PATH"
    exit 1
fi

show_help() {
    cat << EOF
Obsidian-Taskwarrior Sync Commands

Usage: obsidian-taskwarrior-sync <command> [options]

Commands:
  daily               Sync all daily notes
  today               Sync today's daily note
  file <path>         Sync specific file (relative to vault)
  project <folder>    Sync all files in project folder
  all                 Sync entire vault (be careful!)
  help               Show this help

Examples:
  obsidian-taskwarrior-sync daily
  obsidian-taskwarrior-sync today
  obsidian-taskwarrior-sync file "periodic/daily/2025-07-23.md"
  obsidian-taskwarrior-sync project "1-Projects/PhD Dissertation"

Notes:
  - All synced tasks get assigned to the 'obsidian' project in Taskwarrior
  - Use quotes around paths with spaces
  - Hook automatically updates Obsidian when you modify tasks in Taskwarrior
EOF
}

# Get today's date in the format used by daily notes
get_today() {
    date +"%Y-%m-%d"
}

# Main sync function
sync_files() {
    local mask="$1"
    local project="${2:-obsidian}"
    
    echo "üîÑ Syncing: $mask"
    echo "üìÅ Project: $project"
    
    cd "$VAULT_PATH"
    "$SYNC_SCRIPT" --mask "$mask" --project "$project"
}

# Parse command
case "${1:-help}" in
    daily)
        sync_files "periodic/daily/*.md" "daily"
        ;;
    today)
        today_file="periodic/daily/$(get_today).md"
        if [[ -f "$VAULT_PATH/$today_file" ]]; then
            sync_files "$today_file" "today"
        else
            echo "üìù No daily note found for today: $today_file"
            exit 1
        fi
        ;;
    file)
        if [[ -z "${2:-}" ]]; then
            echo "‚ùå Error: Please specify a file path"
            echo "Usage: obsidian-taskwarrior-sync file <path>"
            exit 1
        fi
        file_path="$2"
        if [[ -f "$VAULT_PATH/$file_path" ]]; then
            sync_files "$file_path" "file"
        else
            echo "‚ùå Error: File not found: $file_path"
            exit 1
        fi
        ;;
    project)
        if [[ -z "${2:-}" ]]; then
            echo "‚ùå Error: Please specify a project folder"
            echo "Usage: obsidian-taskwarrior-sync project <folder>"
            exit 1
        fi
        project_folder="$2"
        if [[ -d "$VAULT_PATH/$project_folder" ]]; then
            sync_files "$project_folder/*.md" "$(basename "$project_folder")"
        else
            echo "‚ùå Error: Project folder not found: $project_folder"
            exit 1
        fi
        ;;
    all)
        echo "‚ö†Ô∏è  WARNING: This will sync ALL markdown files in your vault!"
        read -p "Are you sure? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            sync_files "**/*.md" "vault"
        else
            echo "‚ùå Sync cancelled"
        fi
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "‚ùå Unknown command: $1"
        echo "Run 'obsidian-taskwarrior-sync help' for usage"
        exit 1
        ;;
esac