#!/usr/bin/env bash
#
# Quick setup for bugwarrior 1Password items
#

set -euo pipefail

echo "üîê Setting up 1Password items for bugwarrior..."
echo ""
echo "This will help you create the required 1Password items."
echo "You'll need:"
echo "  1. Your Jira email and API token"
echo "  2. Your GitHub username and personal access token(s)"
echo ""

# Function to test 1Password item
test_item() {
    local item_name="$1"
    if op item get "$item_name" --fields label=username &>/dev/null; then
        echo "‚úÖ Found: $item_name"
        return 0
    else
        echo "‚ùå Missing: $item_name"
        return 1
    fi
}

# Check existing items
echo "Checking existing 1Password items..."
echo ""

items_needed=()
test_item "Seqera Jira" || items_needed+=("jira")
test_item "GitHub Token" || items_needed+=("github-work") 
test_item "GitHub Personal Token" || items_needed+=("github-personal")

if [ ${#items_needed[@]} -eq 0 ]; then
    echo ""
    echo "‚úÖ All required 1Password items found!"
    exit 0
fi

echo ""
echo "Let's create the missing items..."
echo ""

# Create Jira item if needed
if [[ " ${items_needed[@]} " =~ " jira " ]]; then
    echo "üìã Seqera Jira Setup"
    echo "Get your API token from: https://seqera.atlassian.net/secure/ViewProfile.jspa"
    echo "Go to 'Personal Access Tokens' and create one"
    echo ""
    read -p "Jira email: " jira_user
    read -s -p "Jira API token: " jira_token
    echo ""
    
    op item create \
        --category=login \
        --title="Seqera Jira" \
        username="$jira_user" \
        password="$jira_token" \
        --vault=Private || echo "Failed to create Jira item"
fi

# Create GitHub work token if needed
if [[ " ${items_needed[@]} " =~ " github-work " ]]; then
    echo ""
    echo "üêô GitHub Token Setup (for Seqera repos)"
    echo "Create token at: https://github.com/settings/tokens"
    echo "Required scopes: repo (full control)"
    echo ""
    read -p "GitHub username: " github_user
    read -s -p "GitHub personal access token: " github_token
    echo ""
    
    op item create \
        --category=login \
        --title="GitHub Token" \
        username="$github_user" \
        password="$github_token" \
        --vault=Private || echo "Failed to create GitHub Token item"
fi

# Create GitHub personal token if needed
if [[ " ${items_needed[@]} " =~ " github-personal " ]]; then
    echo ""
    echo "üêô GitHub Personal Token Setup (for personal repos)"
    echo "You can use the same token as above or create a separate one"
    echo ""
    read -p "Use same token as work? (y/n): " use_same
    
    if [[ "$use_same" == "y" ]]; then
        op item create \
            --category=login \
            --title="GitHub Personal Token" \
            username="$github_user" \
            password="$github_token" \
            --vault=Private || echo "Failed to create GitHub Personal Token item"
    else
        read -p "GitHub username: " github_personal_user
        read -s -p "GitHub personal access token: " github_personal_token
        echo ""
        
        op item create \
            --category=login \
            --title="GitHub Personal Token" \
            username="$github_personal_user" \
            password="$github_personal_token" \
            --vault=Private || echo "Failed to create GitHub Personal Token item"
    fi
fi

echo ""
echo "üéâ Setup complete!"
echo ""
echo "Next steps:"
echo "1. Test with: bugwarrior-pull --dry-run"
echo "2. Run full sync: bugwarrior-pull"