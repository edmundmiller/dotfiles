#!/usr/bin/env bash
#
# Setup 1Password items for bugwarrior authentication
#

set -euo pipefail

echo "🔐 Setting up 1Password items for bugwarrior..."

# Check if op is available
if ! command -v op &> /dev/null; then
    echo "❌ Error: 1Password CLI (op) is not installed"
    echo "Install it from: https://developer.1password.com/docs/cli/get-started"
    exit 1
fi

# Check if user is signed in
if ! op account list &> /dev/null; then
    echo "❌ Error: Not signed in to 1Password"
    echo "Run: op signin"
    exit 1
fi

create_item() {
    local title="$1"
    local username_prompt="$2"
    local password_prompt="$3"
    local additional_info="$4"

    echo ""
    echo "Creating 1Password item: $title"
    echo "$additional_info"
    echo ""
    
    read -p "Username/Login: " username
    read -s -p "Password/Token: " password
    echo ""
    
    # Create the item
    if op item create \
        --category Login \
        --title "$title" \
        username="$username" \
        password="$password" \
        --vault Private 2>/dev/null; then
        echo "✅ Created: $title"
    else
        echo "⚠️  Item '$title' may already exist, skipping..."
    fi
}

echo "This script will create the following 1Password items:"
echo "1. Seqera Jira - For Jira API access"
echo "2. GitHub Token - For Seqera organization repos" 
echo "3. GitHub Personal Token - For your personal repos"
echo ""
read -p "Continue? (y/N): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "❌ Setup cancelled"
    exit 0
fi

# Create Seqera Jira item
create_item \
    "Seqera Jira" \
    "Jira username/email" \
    "Jira API token" \
    "For Seqera Jira access. Get API token from: https://seqera.atlassian.net/secure/ViewProfile.jspa -> Personal Access Tokens"

# Create GitHub Token item  
create_item \
    "GitHub Token" \
    "GitHub username" \
    "GitHub personal access token" \
    "For Seqera organization repos. Create token at: https://github.com/settings/tokens
Minimum scopes: repo (for private repos) or public_repo (for public only)"

# Create GitHub Personal Token item
create_item \
    "GitHub Personal Token" \
    "GitHub username" \
    "GitHub personal access token" \
    "For your personal repos. Can use same token as above or create a separate one.
Create token at: https://github.com/settings/tokens"

echo ""
echo "🎉 1Password items created!"
echo ""
echo "Next steps:"
echo "1. Run 'setup-bugwarrior' to configure taskwarrior UDAs"
echo "2. Run 'bugwarrior-pull' to test the setup"
echo "3. Add 'bugwarrior-pull' to your cron/scheduled tasks"