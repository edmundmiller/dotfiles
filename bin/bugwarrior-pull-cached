#!/usr/bin/env bash
# 
# Bugwarrior pull with 1Password session caching and post-import hooks
#

set -euo pipefail

# Cache the 1Password session for 30 minutes
export OP_SESSION_CACHE_TIMEOUT=1800

# Sign in to 1Password if needed
if ! op account list &>/dev/null; then
    eval $(op signin)
fi

# Export the session token so child processes can use it
export $(env | grep '^OP_SESSION_' || true)

# Change to bugwarrior directory and run
cd ~/src/personal/taskagent/bugwarrior
uv run bugwarrior pull "$@"

# =============================================================================
# Post-import hooks (bugwarrior only supports pre_import, so we run these after)
# =============================================================================

# Linear: Mark Triage/Backlog tasks as waiting (1 year from now)
# These are planned but not ready to work on
task +linear \( linearstatus:Triage or linearstatus:Backlog \) status:pending modify wait:1year 2>/dev/null || true

# Linear: Auto-complete tasks marked Done in Linear
# This handles the case where issues are closed in Linear but still pending in TW
task +linear linearstatus:Done status:pending done 2>/dev/null || true