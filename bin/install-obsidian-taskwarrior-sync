#!/usr/bin/env bash
#
# Install script for obsidian-taskwarrior-sync integration
#

set -euo pipefail

REPO_URL="https://github.com/nbossard/obsidian-taskwarrior-sync.git"
CLONE_DIR="$HOME/repos/obsidian-taskwarrior-sync"
TASKWARRIOR_DATA_DIR="$HOME/Library/Mobile Documents/iCloud~com~mav~taskchamp/Documents/task"
HOOK_DIR="$TASKWARRIOR_DATA_DIR/hooks"
HOOK_FILE="$HOOK_DIR/on-modify.obsidian-sync"

echo "ðŸ”§ Installing obsidian-taskwarrior-sync..."

# Step 1: Clone repository if it doesn't exist
if [[ ! -d "$CLONE_DIR" ]]; then
    echo "ðŸ“¥ Cloning obsidian-taskwarrior-sync repository..."
    mkdir -p "$(dirname "$CLONE_DIR")"
    git clone "$REPO_URL" "$CLONE_DIR"
else
    echo "âœ… Repository already exists at $CLONE_DIR"
    echo "ðŸ“¥ Updating repository..."
    cd "$CLONE_DIR"
    git pull
fi

# Step 2: Apply our space-in-path fixes
echo "ðŸ”§ Applying path fixes for spaces in vault names..."
cd "$CLONE_DIR"

# Fix mtt_md_to_taskwarrior.sh
if grep -q 'rg --no-heading --line-number --with-filename "^- \\[ \\] "  $file_mask' mtt_md_to_taskwarrior.sh; then
    sed -i.bak 's/rg --no-heading --line-number --with-filename "^- \\[ \\] "  $file_mask/rg --no-heading --line-number --with-filename "^- \\[ \\] " "$file_mask"/' mtt_md_to_taskwarrior.sh
    echo "âœ… Fixed mtt_md_to_taskwarrior.sh"
fi

# Fix mtt_md_add_uuids.sh - multiple fixes
declare -a patterns=(
    's/rg --no-heading --line-number --with-filename "\\[id:: \[a-z0-9\]{6}\\]" $file_pattern/rg --no-heading --line-number --with-filename "\\[id:: [a-z0-9]{6}\\]" "$file_pattern"/'
    's/rg --files-with-matches "\\[dependsOn:: $short_id\\]" $file_pattern/rg --files-with-matches "\\[dependsOn:: $short_id\\]" "$file_pattern"/'
    's/rg --files-with-matches "\\[id:: $short_id\\]" $file_pattern/rg --files-with-matches "\\[id:: $short_id\\]" "$file_pattern"/'
    's/rg --no-heading --line-number --with-filename "^- \\[ \\] " $file_pattern/rg --no-heading --line-number --with-filename "^- \\[ \\] " "$file_pattern"/'
)

for pattern in "${patterns[@]}"; do
    if sed -i.bak "$pattern" mtt_md_add_uuids.sh 2>/dev/null; then
        echo "âœ… Applied fix to mtt_md_add_uuids.sh"
    fi
done

# Clean up backup files
rm -f *.bak

# Step 3: Create hook directory if it doesn't exist
echo "ðŸ“ Setting up Taskwarrior hook directory..."
mkdir -p "$HOOK_DIR"

# Step 4: Create the hook file
echo "ðŸª Creating Taskwarrior hook..."
cat > "$HOOK_FILE" << 'EOF'
#!/bin/bash
read -r OLD
read -r NEW
~/repos/obsidian-taskwarrior-sync/mtt_taskwarrior_to_md.sh --task "$NEW"
echo "$NEW"
EOF

# Step 5: Make hook executable
chmod u+x "$HOOK_FILE"

# Step 6: Verify installation
echo "ðŸ” Verifying installation..."

if [[ -x "$CLONE_DIR/mtt_sync.sh" ]]; then
    echo "âœ… Sync scripts installed"
else
    echo "âŒ Sync scripts not found"
    exit 1
fi

if [[ -x "$HOOK_FILE" ]]; then
    echo "âœ… Taskwarrior hook installed"
else
    echo "âŒ Taskwarrior hook not properly installed"
    exit 1
fi

# Step 7: Test requirements
echo "ðŸ§ª Testing requirements..."
if "$CLONE_DIR/mtt_check_requirements.sh"; then
    echo "âœ… All requirements met"
else
    echo "âŒ Missing requirements"
    exit 1
fi

echo ""
echo "ðŸŽ‰ Installation complete!"
echo ""
echo "Usage:"
echo "  obsidian-taskwarrior-sync help      # Show all commands"
echo "  obsidian-taskwarrior-sync daily     # Sync all daily notes"
echo "  obsidian-taskwarrior-sync today     # Sync today's note"
echo ""
echo "The hook is now active - any changes in Taskwarrior will"
echo "automatically update your Obsidian files!"