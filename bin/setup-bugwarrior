#!/usr/bin/env bash
#
# Setup bugwarrior integration with taskwarrior
#

set -euo pipefail

BUGWARRIOR_CONFIG="$HOME/.config/dotfiles/config/bugwarrior/bugwarriorrc"
TASKWARRIOR_CONFIG="$HOME/.config/dotfiles/config/taskwarrior/taskrc"

echo "🔧 Setting up bugwarrior integration..."

# Step 1: Create symlink to bugwarrior config
echo "📁 Creating bugwarrior config symlink..."
mkdir -p "$HOME/.config/bugwarrior"
if [[ ! -L "$HOME/.config/bugwarrior/bugwarriorrc" ]]; then
    ln -sf "$BUGWARRIOR_CONFIG" "$HOME/.config/bugwarrior/bugwarriorrc"
    echo "✅ Linked bugwarrior config"
else
    echo "✅ Bugwarrior config already linked"
fi

# Step 2: Set up taskwarrior UDAs
echo "⚙️  Setting up taskwarrior User Defined Attributes..."
if command -v bugwarrior-uda &> /dev/null; then
    echo "Running bugwarrior-uda to configure taskwarrior fields..."
    bugwarrior-uda
    echo "✅ Taskwarrior UDAs configured"
else
    echo "❌ bugwarrior-uda command not found"
    echo "Make sure bugwarrior is installed: uv tool install bugwarrior"
    exit 1
fi

# Step 3: Verify 1Password integration
echo "🔐 Testing 1Password integration..."
if command -v op &> /dev/null; then
    echo "✅ 1Password CLI found"
    
    # Test if we can access the items (without printing sensitive data)
    if op item list --categories Login | grep -q "Seqera Jira\|GitHub Token"; then
        echo "✅ Found bugwarrior 1Password items"
    else
        echo "⚠️  1Password items not found. Run 'setup-bugwarrior-credentials' first"
    fi
else
    echo "❌ 1Password CLI not found"
    echo "Install from: https://developer.1password.com/docs/cli/get-started"
fi

# Step 4: Test bugwarrior configuration
echo "🧪 Testing bugwarrior configuration..."
if bugwarrior-pull --dry-run 2>/dev/null; then
    echo "✅ Bugwarrior configuration is valid"
else
    echo "❌ Bugwarrior configuration has issues"
    echo "Check the config at: $BUGWARRIOR_CONFIG"
    echo "Run: bugwarrior-pull --dry-run"
fi

echo ""
echo "🎉 Bugwarrior setup complete!"
echo ""
echo "Usage:"
echo "  bugwarrior-pull           # Sync issues from Jira & GitHub"
echo "  bugwarrior-pull --dry-run # Test without importing"
echo "  setup-bugwarrior-sync     # Add to cron for automation"
echo ""
echo "Config locations:"
echo "  ~/.config/bugwarrior/bugwarriorrc -> $BUGWARRIOR_CONFIG"