#!/usr/bin/env bash
#
# Setup automated bugwarrior syncing
#

set -euo pipefail

echo "‚è∞ Setting up automated bugwarrior syncing..."

# Create a wrapper script for safe syncing
SYNC_SCRIPT="$HOME/.local/bin/bugwarrior-sync"
mkdir -p "$(dirname "$SYNC_SCRIPT")"

cat > "$SYNC_SCRIPT" << 'EOF'
#!/usr/bin/env bash
#
# Safe bugwarrior sync with logging
#

set -euo pipeFail

LOG_FILE="$HOME/.local/share/bugwarrior/sync.log"
mkdir -p "$(dirname "$LOG_FILE")"

echo "$(date): Starting bugwarrior sync..." >> "$LOG_FILE"

# Ensure 1Password session is available
if ! op account list &> /dev/null; then
    echo "$(date): ERROR - Not signed in to 1Password" >> "$LOG_FILE"
    exit 1
fi

# Run bugwarrior with error handling
if bugwarrior-pull 2>&1 >> "$LOG_FILE"; then
    echo "$(date): Sync completed successfully" >> "$LOG_FILE"
else
    echo "$(date): ERROR - Sync failed" >> "$LOG_FILE"
    exit 1
fi
EOF

chmod +x "$SYNC_SCRIPT"
echo "‚úÖ Created sync script at $SYNC_SCRIPT"

# Add to user's PATH if needed
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
    echo ""
    echo "‚ö†Ô∏è  Add ~/.local/bin to your PATH:"
    echo "echo 'set PATH \$HOME/.local/bin \$PATH' >> ~/.config/fish/config.fish"
fi

# Create launchd plist for macOS automation
PLIST_DIR="$HOME/Library/LaunchAgents"
PLIST_FILE="$PLIST_DIR/com.user.bugwarrior.plist"

echo ""
echo "Setting up automated sync (every 30 minutes)..."
read -p "Create launchd job for automatic syncing? (y/N): " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    mkdir -p "$PLIST_DIR"
    
    cat > "$PLIST_FILE" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.user.bugwarrior</string>
    <key>ProgramArguments</key>
    <array>
        <string>$SYNC_SCRIPT</string>
    </array>
    <key>StartInterval</key>
    <integer>1800</integer>
    <key>RunAtLoad</key>
    <false/>
    <key>StandardOutPath</key>
    <string>$HOME/.local/share/bugwarrior/launchd.log</string>
    <key>StandardErrorPath</key>
    <string>$HOME/.local/share/bugwarrior/launchd-error.log</string>
</dict>
</plist>
EOF

    # Load the launchd job
    launchctl load "$PLIST_FILE"
    echo "‚úÖ Created and loaded launchd job"
    echo "üìÅ Logs: ~/.local/share/bugwarrior/"
else
    echo "‚ÑπÔ∏è  Manual sync: run 'bugwarrior-sync' or 'bugwarrior-pull'"
fi

echo ""
echo "üéâ Bugwarrior sync automation setup complete!"
echo ""
echo "Commands:"
echo "  bugwarrior-sync          # Safe sync with logging"
echo "  bugwarrior-pull          # Direct bugwarrior command"
echo "  launchctl unload $PLIST_FILE  # Disable automation"
echo ""
echo "Logs:"
echo "  ~/.local/share/bugwarrior/sync.log"
echo "  ~/.local/share/bugwarrior/launchd.log"